#include <stdio.h>
#include <stdlib.h>
#include <stdint.h>
#include "data.h"
#include "rsa.h"
#include "sha256.h"

static const struct rsa_public_key my_key = {
    .size   = 64,
    .n0inv  = 0x8ae37005,
    .n = {
        0xd8e02333,         0x027f6ef2,         0x5baf5a81,         0xda65a8ac,
        0x3e699298,         0x3850e5a2,         0xc5ffd6d7,         0xec94c3c4,
        0xa1718723,         0xd1f77269,         0xbd62bc6d,         0x37a82a04,
        0x877ee1de,         0x34c75bf1,         0xf5adcb65,         0xce9a3c5a,
        0x15bcabe1,         0x2ea3bc48,         0xb8a2145f,         0x8a89fbb8,
        0x5be454f3,         0x92fc6aeb,         0x7220e810,         0x3299f1eb,
        0x63221d74,         0x25831811,         0x47d50bab,         0x71b98094,
        0x150c8478,         0x6d734bae,         0x8fbd3489,         0x11bb0944,
        0xa71d0856,         0xb4f24895,         0x0645013d,         0xada2f43d,
        0xfa1d8a33,         0xe3b2a0d5,         0xc0ec2c93,         0xe70c3d79,
        0xa2af3116,         0xe17451ed,         0x98ae29c6,         0xb659cf28,
        0xe463c8a4,         0x116d7014,         0xc65fd44d,         0xf3fa045e,
        0x4cd2b3ef,         0xe8839d2d,         0x9f3a4fbe,         0xd65e0d3f,
        0xf926a401,         0x83e1eb18,         0xc9b219ca,         0x4cde4117,
        0x03c55a86,         0xe661f5f3,         0xe35e6ec2,         0xfa1fc534,
        0x92e1452f,         0xd5465206,         0xe1910df7,         0xfaa6cca0
    },
    .rr = {
        0x6b40522a,         0x07e3e3bd,         0x8bcea806,         0xf866c607,
        0x232f8373,         0x8317657b,         0xc6d2a297,         0xd4339f3e,
        0x7a889859,         0x3709f19b,         0x7e3531ec,         0x8f383f26,
        0x5d29815e,         0x37fc00c2,         0x1905bfeb,         0x44199ec4,
        0x7ba5c537,         0x93de1b81,         0x680890ff,         0xbdb6cae5,
        0xd99ee5a2,         0x22e99c2c,         0x3f48c0a7,         0x8fce129e,
        0xc5d2556c,         0xb1636c71,         0x50eecb91,         0xda615920,
        0xa429abc3,         0x030fdc66,         0x7b152c3d,         0x16158f6c,
        0x26747050,         0xb00d1af6,         0x30a342f9,         0x9ce384d9,
        0xe84889a7,         0x32d6d510,         0x2978acca,         0x13311410,
        0xcce08242,         0x589d0b36,         0xa236bb43,         0x6b8876bd,
        0xf3bfe517,         0x0a44e102,         0xb0b52bd1,         0x4ad3efc5,
        0x1ab3b3c1,         0x8c48ee06,         0xfafe3420,         0x8956186b,
        0x5d08dd90,         0x9a23b2e1,         0x229f0606,         0x4f14aedd,
        0x9a8e6417,         0x1ae51b0d,         0xb7fd301e,         0x452f1a7c,
        0x43e533b0,         0xf5628a9f,         0x75a920e0,         0x668a214c
    }
};

const uint8_t my_signature[256] = {
    0x38, 0x16, 0xbf, 0xc0, 0xed, 0xd9, 0xaa, 0x66, 0x9b, 0x1e, 0xc0, 0x89, 
    0x2d, 0xe0, 0xa9, 0x95, 0x3e, 0x46, 0x4a, 0x94, 0x20, 0x3e, 0x66, 0x6f, 
    0xa6, 0x06, 0xb2, 0x3d, 0x75, 0xdd, 0x69, 0x62, 0xe3, 0xfd, 0x6e, 0x6b, 
    0xbe, 0x69, 0x08, 0x49, 0x29, 0x1a, 0x67, 0x05, 0x10, 0x59, 0x67, 0xcc, 
    0xd6, 0xde, 0x6b, 0x70, 0xcc, 0x12, 0x6f, 0x9e, 0x3e, 0xa7, 0x1d, 0xa3, 
    0x2f, 0xa9, 0xb0, 0xd5, 0x77, 0xc3, 0xbd, 0xe9, 0x88, 0x02, 0xa8, 0xec, 
    0x08, 0xb6, 0x3b, 0x8a, 0xe1, 0x1a, 0xeb, 0x08, 0x64, 0x6b, 0xad, 0xeb, 
    0x93, 0x33, 0xe9, 0x68, 0x89, 0x24, 0xaa, 0xc5, 0xed, 0xc4, 0xca, 0x48, 
    0xb8, 0x2d, 0xc7, 0x04, 0x3d, 0x4f, 0x81, 0x6d, 0xda, 0x4d, 0x90, 0xa4, 
    0xea, 0x96, 0x60, 0x84, 0x68, 0xe4, 0xc5, 0x5a, 0xe5, 0x67, 0x40, 0xd0, 
    0xb3, 0x4a, 0xfe, 0x25, 0xf4, 0x96, 0xe4, 0x9b, 0xf8, 0x09, 0x07, 0x6c, 
    0x67, 0xe5, 0xcd, 0xd0, 0xb9, 0x7c, 0x01, 0xf5, 0x9b, 0xbf, 0x28, 0x40, 
    0x34, 0xe6, 0xe7, 0x44, 0x0c, 0x7f, 0xf8, 0x7a, 0xa5, 0xd1, 0x3f, 0x72, 
    0x07, 0x96, 0xec, 0x5b, 0xe4, 0x42, 0x5b, 0x92, 0x6f, 0x6a, 0x5d, 0xa5, 
    0x04, 0x27, 0xb1, 0x51, 0xc7, 0x6c, 0xd7, 0x46, 0xe5, 0x20, 0x3b, 0xa5, 
    0xcb, 0x25, 0xee, 0x80, 0xfc, 0xfd, 0x1c, 0x44, 0x94, 0xff, 0x28, 0x3f, 
    0x10, 0xee, 0x9d, 0x8f, 0x0d, 0xde, 0x19, 0x05, 0xf8, 0x4e, 0x4b, 0x04, 
    0x3b, 0x63, 0xec, 0xca, 0x44, 0x74, 0x34, 0x48, 0x56, 0x15, 0xa3, 0xb0, 
    0xb2, 0x12, 0x78, 0x0d, 0x64, 0xf3, 0x03, 0x74, 0x87, 0x75, 0x61, 0xf7, 
    0x62, 0x65, 0xf1, 0xab, 0xb5, 0xf0, 0x76, 0x0a, 0x90, 0xc5, 0x47, 0x08, 
    0xd1, 0x86, 0xf8, 0x83, 0xd1, 0x98, 0xce, 0x82, 0x88, 0xbb, 0x3c, 0x6e, 
    0x5d, 0xbc, 0xdc, 0x0b
};

static uint32_t rsa_workbuf[3 * RSANUMWORDS];

int main(int argc, char *argv[])
{
    uint8_t *rwdata;
    long rwlen;
    int status;

    // Image
    rwdata = data;
    rwlen = data_len;

	struct sha256_ctx ctx;
	uint8_t *hash;
    SHA256_init(&ctx);
    SHA256_update(&ctx, rwdata, rwlen);
    hash = SHA256_final(&ctx);

    status = rsa_verify(&my_key, my_signature, hash, rsa_workbuf);

    if (status)
      printf("Signature matches!\n");
    else
      printf("Signature does not match :-(\n");
    return status;
}
